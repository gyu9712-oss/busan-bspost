<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Open-Meteo ë‚ ì”¨ ì§€ë„ (ë¶€ì‚° ì´ë¥œì°¨ ì˜ˆë°©ìˆ˜ì¹™)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; }
    .legend {
      position: absolute;
      z-index: 1000;
      right: 12px;
      bottom: 12px;
      background: rgba(255,255,255,.95);
      padding: 8px 10px;
      border-radius: 8px;
      font: 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      box-shadow: 0 2px 10px rgba(0,0,0,.1);
      max-width: 220px;
    }
    .legend div { display: flex; align-items: center; gap: 6px; margin: 3px 0; }
    .legend .sw { width: 10px; height: 10px; border-radius: 2px; display: inline-block; }
    .badge { display:inline-block; padding:2px 8px; border-radius:10px; font-weight:600; color:#fff }
    .muted { color:#666; font-size:12px }
    pre { white-space: pre-wrap; margin: 6px 0 0; }
    .toolbar {
      position:absolute;
      left:12px;
      top:12px;
      z-index:1000;
      background:rgba(255,255,255,.95);
      padding:8px 10px;
      border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,.1);
      font: 13px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .toolbar button{
      cursor:pointer;
      border:1px solid #e5e7eb;
      background:#fff;
      padding:6px 10px;
      border-radius:8px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="toolbar">
    <button id="refreshBtn">â†» ìƒˆë¡œê³ ì¹¨</button>
    <span id="updated" class="muted" style="margin-left:8px">ì—…ë°ì´íŠ¸ ëŒ€ê¸°â€¦</span>
  </div>
  <div class="legend">
    <b>ìœ„í—˜ë„</b>
    <div><span class="sw" style="background:#10b981"></span> ë‚®ìŒ</div>
    <div><span class="sw" style="background:#3b82f6"></span> ë³´í†µ</div>
    <div><span class="sw" style="background:#f59e0b"></span> ì£¼ì˜</div>
    <div><span class="sw" style="background:#dc2626"></span> ê²½ê³„</div>
    <div><span class="sw" style="background:#b91c1c"></span> ì‹¬ê°</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const KST = 'Asia/Seoul';
    const FETCH_TIMEOUT_MS = 12000;
    const OPEN_METEO = ({lat, lon}) =>
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&models=kma_seamless&current=temperature_2m,relative_humidity_2m,is_day,weather_code,rain,showers,snowfall,wind_speed_10m&timezone=${encodeURIComponent(KST)}&windspeed_unit=ms`;

    // âœ… ë¶€ì‚°ë§Œ í‘œì‹œ
    const cities = [
      { name: "ë¶€ì‚°", lat: 35.1033445, lon: 129.0359688 }
    ];

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const withTimeout = (p, ms) => Promise.race([p, new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), ms))]);
    const fmt = (n, dp=0) => (n===undefined || n===null || Number.isNaN(n)) ? '-' : Number(n).toFixed(dp);
    const nowStr = () => new Date().toLocaleString('ko-KR', { timeZone: KST });

    function weatherFromCode(code) {
      if (code === 0) return { main: "Clear", description: "ë§‘ìŒ" };
      if ([1,2,3].includes(code)) return { main: "Clouds", description: code===1?"ëŒ€ì²´ë¡œ ë§‘ìŒ": code===2?"ë¶€ë¶„ íë¦¼":"íë¦¼" };
      if ([45,48].includes(code)) return { main: "Fog", description: "ì•ˆê°œ/ì§™ì€ ì•ˆê°œ" };
      if ([51,53,55,56,57].includes(code)) return { main: "Drizzle", description: "ì´ìŠ¬ë¹„/ì–¸ ì´ìŠ¬ë¹„" };
      if ([61,63,65,66,67,80,81,82].includes(code)) return { main: "Rain", description: "ë¹„/ì†Œë‚˜ê¸°" };
      if ([71,73,75,77,85,86].includes(code)) return { main: "Snow", description: "ëˆˆ/ì†Œë‚™ëˆˆ" };
      if ([95,96,99].includes(code)) return { main: "Thunderstorm", description: "ë‡Œìš°" };
      return { main: "Clouds", description: "íë¦¼" };
    }

    function colorForLevel(level) {
      return level === "ì‹¬ê°" ? "#b91c1c" :
             level === "ê²½ê³„" ? "#dc2626" :
             level === "ì£¼ì˜" ? "#f59e0b" :
             level === "ë³´í†µ" ? "#3b82f6" : "#10b981";
    }

    function assessHazard({ main, tempC, windMs, rainMm, snowMm }) {
      let level = "ë³´í†µ";
      let type = main;
      let tips = [];

      const set = (lvl, typ, arr) => { level = lvl; type = typ; tips = arr.slice(); };

      if (main === "Thunderstorm") {
        set(rainMm > 10 ? "ì‹¬ê°" : "ê²½ê³„", "ë‡Œìš°/í˜¸ìš°", [
          "ê°•í•œ ë¹„Â·ë²ˆê°œ ì‹œ ìš´í–‰ ì¤‘ì§€, ì‹¤ë‚´ ëŒ€ê¸°",
          "ì§€í•˜ì°¨ë„Â·í•˜ì²œ ì¸ê·¼ ì¹¨ìˆ˜ ë„ë¡œ ì§„ì… ê¸ˆì§€",
          "ì‹œì•¼ ê¸‰ê°: ì†ë„ 30% ê°ì†"
        ]);
      } else if (main === "Rain" || main === "Drizzle") {
        set(rainMm > 30 ? "ì‹¬ê°" : rainMm > 10 ? "ê²½ê³„" : "ì£¼ì˜", "ë¹„/ì –ì€ ë…¸ë©´", [
          "ê°ì†(í‰ì†Œ ëŒ€ë¹„ 20~30%), ì œë™ê±°ë¦¬ 2ë°°",
          "ë§¨í™€Â·ë„ìƒ‰Â·ì² íŒ ìœ„ í†µê³¼ ê¸ˆì§€"
        ]);
      } else if (main === "Snow") {
        set(snowMm > 5 ? "ê²½ê³„" : "ì£¼ì˜", "ëŒ€ì„¤/ê²°ë¹™", [
          "ë¸”ë™ì•„ì´ìŠ¤ ì‹œê°„ëŒ€ ìš´í–‰ ìì œ",
          "ê¸‰ê°€ê°ì† ê¸ˆì§€"
        ]);
      } else if (main === "Clear") {
        if (tempC >= 35) {
          set("ê²½ê³„", "í­ì—¼", ["ê·¸ëŠ˜ íœ´ì‹Â·ìˆ˜ë¶„ ë³´ì¶©"]);
        } else if (tempC >= 33) {
          set("ì£¼ì˜", "í­ì—¼", ["ê·¸ëŠ˜ íœ´ì‹Â·ìˆ˜ë¶„ ë³´ì¶©"]);
        } else if (tempC <= -10) {
          set("ê²½ê³„", "í•œíŒŒ", ["í•¸ë“¤ì›Œë¨¸ ì‚¬ìš©", "ì„œí–‰"]);
        } else {
          set("ë‚®ìŒ", "ë§‘ìŒ", ["PPE(ë³´í˜¸ì¥ë¹„) í•„ìˆ˜ ì°©ìš©"]);
        }
      } else if (main === "Clouds") {
        set("ë³´í†µ", "êµ¬ë¦„/ê±´ì¡°", ["ê·œì • ì†ë„ ìœ ì§€"]);
      } else if (main === "Fog") {
        set("ì£¼ì˜", "ì•ˆê°œ", ["ì €ì† ì£¼í–‰", "ë¡œìš°ë¹” ì‚¬ìš©"]);
      }

      if (windMs >= 14) {
        const windLevel = windMs >= 20 ? "ì‹¬ê°" : "ê²½ê³„";
        set(windLevel, "ê°•í’", ["íš¡í’ êµ¬ê°„ íšŒí”¼", "ëŒ€í˜•ì°¨ ì¶”ì›” ê¸ˆì§€"]);
      }

      tips.push("ê³µí†µ: PPE ì°©ìš©, ì°¨ê°„ê±°ë¦¬ í™•ë³´");
      return { level, type, tips };
    }

    const map = L.map('map').setView([35.1033445, 129.0359688], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    const markerLayer = L.layerGroup().addTo(map);
    const circleLayer = L.layerGroup().addTo(map);
    const updatedEl = document.getElementById('updated');

    function cityPopup({name, wc, temp, humidity, wind, rain, snow, hazard}) {
      const badge = `<span class="badge" style="background:${colorForLevel(hazard.level)}">${hazard.level}</span>`;
      return `
        ğŸ“ <b>${name}</b><br/>
        ğŸŒ¤ï¸ ìƒíƒœ: ${wc.description} (${wc.main})<br/>
        ğŸŒ¡ï¸ ${fmt(temp,0)}Â°C Â· ğŸ’§${fmt(humidity,0)}% Â· ğŸŒ¬ï¸${fmt(wind,1)} m/s<br/>
        ğŸŒ§ï¸ ${fmt(rain,1)} mm Â· â„ï¸ ${fmt(snow,1)} mm<br/><br/>
        <b>ğŸ›¡ï¸ ì´ë¥œì°¨ ì˜ˆë°©ì±…</b> ${badge}<br/>
        ìƒí™© ë¶„ë¥˜: <b>${hazard.type}</b>
        <pre>${hazard.tips.map(t => `- ${t}`).join('\n')}</pre>
        <div class="muted">ë°ì´í„°: Open-Meteo (KMA Seamless) Â· ${KST}</div>
      `;
    }

    async function fetchCityWeather(city) {
      const url = OPEN_METEO(city);
      const res = await withTimeout(fetch(url), FETCH_TIMEOUT_MS);
      const data = await res.json();
      const cur = data.current || {};
      const wc = weatherFromCode(cur.weather_code ?? 3);
      const temp = cur.temperature_2m;
      const humidity = cur.relative_humidity_2m;
      const wind = cur.wind_speed_10m;
      const rain = Math.max(cur.rain ?? 0, cur.showers ?? 0);
      const snow = cur.snowfall ?? 0;
      const hazard = assessHazard({ main: wc.main, tempC: temp, windMs: wind, rainMm: rain, snowMm: snow });
      return { wc, temp, humidity, wind, rain, snow, hazard };
    }

    async function render() {
      markerLayer.clearLayers();
      circleLayer.clearLayers();
      updatedEl.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      const city = cities[0];
      try {
        const info = await fetchCityWeather(city);
        const marker = L.marker([city.lat, city.lon]).addTo(markerLayer);
        marker.bindPopup(cityPopup({ name: city.name, ...info })).openPopup();
        const color = colorForLevel(info.hazard.level);
        L.circleMarker([city.lat, city.lon], {
          radius: 20, color, fillColor: color, fillOpacity: 0.25
        }).addTo(circleLayer);
        updatedEl.textContent = `ì—…ë°ì´íŠ¸: ${nowStr()}`;
      } catch (e) {
        updatedEl.textContent = `ì˜¤ë¥˜: ${e.message}`;
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', render);
    render();
  </script>
</body>
</html>
